---
title: Intro
cover-photo: assets/images/banner.jpg
cover-photo-alt: example cover photo
auto-header: none
icon: fa-comment
order: 1
---
<header>
  <h2 class="alt">Hi! I'm <strong>Prologue</strong>, a <a href="http://html5up.net/license">free</a> responsive<br />
  site template designed by <a href="http://html5up.net/prologue">HTML5 UP</a>.</h2>
  <p>Adapted for Jekyll by <a href=https://chrisbobbe.github.io/>Chris Bobbe</a>. Get started on <a href="https://github.com/chrisbobbe/jekyll-theme-prologue">GitHub!</a></p>
</header>


<script src="https://applepay.cdn-apple.com/jsapi/v1/apple-pay-sdk.js"></script>


  <style>
  apple-pay-button {
    --apple-pay-button-width: 300px;
    --apple-pay-button-height: 60px;
    --apple-pay-button-border-radius: 3px;
    --apple-pay-button-padding: 0px 0px;
    --apple-pay-button-box-sizing: border-box;
  }
  

    div.main {
        width: 350px;
    }

    .ap {
           border: 0;
           width: 250px;
           height: auto;
           min-height: 55px;
           padding: 0px;
           margin-bottom: 12px;
       }

        input {
            border: 1px solid black;
            font-size: 14px;
            padding: 3px;
            width: 250px;
            margin-bottom: 12px;
        }

        .hidden {
            display: none;
        }

        textarea {
            border: 1px solid black;
            width: 100%;
        }
  </style>
  
  <div id="payDiv">
    <apple-pay-button id="applePay" buttonstyle="black" type="plain" locale="en"></apple-pay-button>
    <!-- <apple-pay-button id="applePay2" buttonstyle="black" type="plain" locale="en"></apple-pay-button> -->
  </div>

  <div class="main">
        <form id="payment-form" method="POST">
            <input id="amount" name="xAmount" placeholder="Amount" type="number" inputmode="decimal"></input>
            <br />
            <div id="ap-container" class="ap hidden">
                <br />
            </div>
            <br />
            <label id="lbAPPayload" class="hidden">Apple Pay Payload: </label>
            <br />
            <textarea id="ap-payload" class="hidden" rows="10" readonly="true"></textarea>
            <br />
        </form>
    </div>

  <script>
    // github 예제
    
    document.addEventListener("DOMContentLoaded", function (event) {
            ckApplePay.enableApplePay({
                initFunction: 'apRequest.initAP',
                amountField: 'amount'
            });
        });

        const apRequest = {
            buttonOptions: {
                buttonContainer: "ap-container",
                buttonColor: APButtonColor.black,
                buttonType: APButtonType.pay
            },
            taxAmt: null,
            shippingMethod: null,
            creditType: null,
            getTransactionInfo: function (taxAmt, shippingMethod, creditType) {
                try {
                    this.shippingMethod = shippingMethod || this.shippingMethod || {
                        "label": "Free Shipping",
                        "amount": "0.00",
                        "type": "final"
                    };
                    this.taxAmt = roundToNumber(taxAmt, 4) || this.taxAmt || 0.07;
                    this.creditType = creditType || this.creditType;
                    const amt = getAmount();
                    const lineItems = [
                        {
                            "label": "Subtotal",
                            "type": "final",
                            "amount": amt
                        },
                        this.shippingMethod
                    ];
                    if (this.creditType === "credit") {
                        lineItems.push({
                            "label": "Credit Card Fee",
                            "amount": roundTo(0.0275 * amt, 2),
                            "type": "final"
                        });
                    }
                    lineItems.push({
                        "label": "Estimated Tax",
                        "amount": roundTo(this.taxAmt * amt, 2),
                        "type": "final"
                    });
                    let totalAmt = 0;
                    lineItems.forEach((item) => {
                        totalAmt += parseFloat(item.amount) || 0;
                    });
                    totalAmt = roundTo(totalAmt, 2);

                    return {
                        'lineItems': lineItems,
                        total: {
                            type: 'final',
                            label: 'Total',
                            amount: totalAmt,
                        }
                    };
                } catch (err) {
                    console.error("getTransactionInfo error ", exMsg(err));
                    if (isDebugEnv) {
                        alert("getTransactionInfo error: " + exMsg(err));
                    }
                }
            },
            onGetTransactionInfo: function () {
                try {
                    return this.getTransactionInfo();
                } catch (err) {
                    console.error("onGetTransactionInfo error ", exMsg(err));
                    if (isDebugEnv) {
                        alert("onGetTransactionInfo error: " + exMsg(err));
                    }
                }
            },
            onGetShippingMethods: function () {
                return [
                    {
                        label: 'Free Shipping',
                        amount: '0.00',
                        identifier: 'free',
                        detail: 'Delivers in five business days',
                    },
                    {
                        label: 'Express Shipping',
                        amount: '5.00',
                        identifier: 'express',
                        detail: 'Delivers in two business days',
                    },
                ];
            },
            onShippingContactSelected: function (shippingContact) {
                const self = this;
                return new Promise(function (resolve, reject) {
                    try {
                        console.log("shippingContact", JSON.stringify(shippingContact));
                        let taxAmt = 0.1;
                        const newShippingMethods = [
                            {
                                label: 'Free Shipping',
                                amount: '0.00',
                                identifier: 'free',
                                detail: 'Delivers in five business days',
                            }
                        ];
                        if (shippingContact && shippingContact.administrativeArea) {
                            if (shippingContact.administrativeArea === "NY") {
                                taxAmt = 0.0875;
                                newShippingMethods.push(
                                    {
                                        label: 'Overnight Shipping',
                                        amount: '10.00',
                                        identifier: 'overnight',
                                        detail: 'Delivers in one business days',
                                    }
                                );
                            } else if (shippingContact.administrativeArea === "NJ") {
                                taxAmt = 0.07;
                                newShippingMethods.push(
                                    {
                                        label: 'Express Shipping',
                                        amount: '5.00',
                                        identifier: 'express',
                                        detail: 'Delivers in two business days',
                                    }
                                );
                            }
                        }
                        const resp = self.getTransactionInfo(taxAmt, newShippingMethods[0]);
                        resp.shippingMethods = newShippingMethods;
                        resolve(resp);
                    } catch (err) {
                        const apErr = {
                            code: "-101",
                            contactField: "",
                            message: exMsg(err)
                        }
                        console.error("onShippingContactSelected error.", exMsg(err));
                        if (isDebugEnv) {
                            setTimeout(function () { alert("onShippingContactSelected error: " + exMsg(err)) }, 100);
                        }
                        reject({ errors: [err] });
                    }
                })
            },
            onShippingMethodSelected: function (shippingMethod) {
                const self = this;
                return new Promise(function (resolve, reject) {
                    try {
                        console.log("shippingMethod", JSON.stringify(shippingMethod));
                        const resp = self.getTransactionInfo(null, shippingMethod);
                        resolve(resp);
                    } catch (err) {
                        const apErr = {
                            code: "-102",
                            contactField: "",
                            message: exMsg(err)
                        }
                        console.error("onShippingMethodSelected error.", exMsg(err));
                        if (isDebugEnv) {
                            setTimeout(function () { alert("onShippingMethodSelected error: " + exMsg(err)) }, 100);
                        }
                        reject({ errors: [err] });
                    }
                })
            },
            onPaymentMethodSelected: function (paymentMethod) {
                const self = this;
                return new Promise(function (resolve, reject) {
                    try {
                        console.log("paymentMethod", JSON.stringify(paymentMethod));
                        const resp = self.getTransactionInfo(null, null, paymentMethod.type);
                        resolve(resp);
                    } catch (err) {
                        const apErr = {
                            code: "-102",
                            contactField: "",
                            message: exMsg(err)
                        }
                        console.error("onPaymentMethodSelected error.", exMsg(err));
                        if (isDebugEnv) {
                            setTimeout(function () { alert("onPaymentMethodSelected error: " + exMsg(err)) }, 100);
                        }
                        reject({ errors: [err] });
                    }
                })
            },
            onValidateMerchant: function (validationUrl) {
                return new Promise(function (resolve, reject) {
                    try {
                        if (isDebugEnv) {
                            alert("onValidateMerchant: " + JSON.stringify(event), validationUrl);
                        }
                        console.log("validationUrl: " + validationUrl)
                        ckApplePay.getSession(validationUrl)
                            .then(function (response) {
                                try {
                                    console.log(response);
                                    //setTimeout(function(){ alert("onValidateMerchant: "+JSON.stringify(response))}, 100);
                                    resolve(response);
                                } catch (err) {
                                    console.error("getApplePaySession exception.", JSON.stringify(err));
                                    setTimeout(function () { alert("onValidateMerchant error: " + exMsg(err)) }, 100);
                                    reject(err);
                                }
                            })
                            .catch(function (err) {
                                console.error("getApplePaySession error.", JSON.stringify(err));
                                setTimeout(function () { alert("getApplePaySession error: " + exMsg(err)) }, 100);
                                reject(err);
                            });
                    } catch (err) {
                        console.error("onValidateMerchant error.", JSON.stringify(err));
                        if (isDebugEnv) {
                            setTimeout(function () { alert("onValidateMerchant error: " + exMsg(err)) }, 100);
                        }
                        reject(err);
                    }
                })
            },
            onPaymentAuthorize: function (paymentResponse) {
                return new Promise(function (resolve, reject) {
                    try {
                        // if (isDebugEnv) {
                        //     alert("onPaymentAuthorize: "+JSON.stringify(token));
                        // }

                        console.log("paymentResponse: " + paymentResponse)

                        ckApplePay.authorize(paymentResponse.token)
                            .then(function (response) {
                                try {
                                    console.log(response);
                                    const respPayload = "Apple Response (PaymentResponse):\n---------------------\n" +
                                        JSON.stringify(paymentResponse, null, 2) +
                                        "\n\nGateway Response (CompleteResponse):\n---------------------\n" +
                                        response;
                                    setAPPayload(respPayload);
                                    const resp = JSON.parse(response);
                                    if (!resp)
                                        throw "Invalid response: " + response;
                                    if (resp.xError) {
                                        throw resp;
                                    }
                                    resolve(response);
                                } catch (err) {
                                    throw err;
                                    // console.error("authorizeAPay exception.", JSON.stringify(err));
                                    // setTimeout(function(){ alert("onPaymentAuthorize error: "+exMsg(err))}, 100);
                                    // reject(err);
                                }
                            })
                            .catch(function (err) {
                                console.error("authorizeAPay error.", JSON.stringify(err));
                                apRequest.handleAPError(err);
                                reject(err);
                            });
                    } catch (err) {
                        console.error("onPaymentAuthorize error.", JSON.stringify(err));
                        apRequest.handleAPError(err);
                        reject(err);
                    }
                })
            },
            onPaymentComplete: function (paymentComplete) {
                if (paymentComplete.response) { //Success
                    const resp = JSON.parse(paymentComplete.response);
                    if (resp.xRefNum) {
                        setTimeout(function () { alert("Thank you for your order:(" + resp.xRefNum + ")") }, 100);
                    } else {
                        setTimeout(function () { alert("Thank you for your order.") }, 100);
                    }
                } else if (paymentComplete.error) {
                    console.error("onPaymentComplete", exMsg(paymentComplete.error));
                    handleAPError(paymentComplete.error);
                }

            },
            handleAPError: function (err) {
                if (err && err.xRefNum) {
                    setTimeout(function () { alert("There was a problem with your order:(" + err.xRefNum + ")") }, 100);
                } else {
                    setTimeout(function () { alert("There was a problem with your order:" + exMsg(err)) }, 100);
                }
            },
            initAP: function () {
                return {
                    buttonOptions: this.buttonOptions,
                    merchantIdentifier: "merchant.cardknoxdev.com",
                    requiredBillingContactFields: ['postalAddress', 'name', 'phone', 'email'],
                    requiredShippingContactFields: ['postalAddress', 'name', 'phone', 'email'],
                    onGetTransactionInfo: "apRequest.onGetTransactionInfo",
                    onGetShippingMethods: "apRequest.onGetShippingMethods",
                    onShippingContactSelected: "apRequest.onShippingContactSelected",
                    onShippingMethodSelected: "apRequest.onShippingMethodSelected",
                    onPaymentMethodSelected: "apRequest.onPaymentMethodSelected",
                    onValidateMerchant: "apRequest.onValidateMerchant",
                    onPaymentAuthorize: "apRequest.onPaymentAuthorize",
                    onPaymentComplete: "apRequest.onPaymentComplete",
                    onAPButtonLoaded: "apRequest.apButtonLoaded",
                    isDebug: isDebugEnv
                };
            },
            apButtonLoaded: function (resp) {
                if (!resp) return;
                if (resp.status === iStatus.success) {
                    showHide(this.buttonOptions.buttonContainer, true);
                    showHide("lbAPPayload", true);
                } else if (resp.reason) {
                    alert(resp.reason);
                }
            }
        };
        function setAPPayload(value) {
            const apTxt = document.getElementById('ap-payload');
            apTxt.value = value;
            showHide(apTxt, value);
        }

        function showHide(elem, toShow) {
            if (typeof (elem) === "string") {
                elem = document.getElementById(elem);
            }
            if (elem) {
                toShow ? elem.classList.remove("hidden") : elem.classList.add("hidden");
            }
        }
        function getAmount() {
            return roundToNumber(document.getElementById("amount").value || "0", 2);
        }



    // ======================
    function buttonClick(){
        if (window.ApplePaySession) {
            var merchantIdentifier = 'example.com.store';
            var promise = ApplePaySession.canMakePaymentsWithActiveCard(merchantIdentifier);
            promise.then(function (canMakePayments) {
                if (canMakePayments) {
                    // Display Apple Pay Buttons here…
                } else {
                    // Check for the existence of the openPaymentSetup method.
                    if (ApplePaySession.openPaymentSetup) {
                        // Display the Set up Apple Pay Button here…             
                        ApplePaySession.openPaymentSetup(merchantIdentifier)
                        .then(function(success) {
                            if (success) {
                                alert("실행 가능합니다.");
                            } else {
                                alert("설정 불러오는데 실패하였습니다.");
                            }
                        })
                        .catch(function(e) {
                            alert(e + "에러가 발생하였습니다.");
                        });
                    }
                }
            }); 
        }
    }

    // document.getElementById('applePay2').addEventListener('click', ()=>{
    //     console.log('clickd');
    //     buttonClick();
    // });

    function onApplePayButtonClicked() {
        if (!ApplePaySession) return;
        // Define ApplePayPaymentRequest
        const request = {
            countryCode: "US",
            currencyCode: "USD",
            merchantCapabilities: [
                "supports3DS"
            ],
            supportedNetworks: [
                "visa",
                "masterCard",
                "amex",
                "discover"
            ],
            total: {
                label: "Demo (Card is not charged)",
                type: "final",
                amount: "2000"
            },
            lineItems: [
                {
                    "label": "Bag Subtotal",
                    "type": "final",
                    "amount": "35.00"
                },
                {
                    "label": "Free Shipping",
                    "amount": "0.00",
                    "type": "final"
                },
                {
                    "label": "Estimated Tax",
                    "amount": "3.06",
                    "type": "final"
                }
            ]
        };
        // 세션 생성
        const session = new ApplePaySession(3, request);
        console.log(session);
        // 지불 명세서를 표시할 때 시스템이 호출하는 이벤트 핸들러
        session.onvalidatemerchant = async (event)=>{
            const merchantSession = await validateMerchant();
            session.completeMerchantValidation(merchantSession);
        };
        // 사용자가 새 결제 수단을 선택할 때 호출
        session.onpaymentmethodselected = (event)=>{
            const update = {
            };
            // 30초 시간 초과 전에 호출하여 응답
            session.completePaymentMethodSelection(update);
        };
        // 사용자가 배송 방법을 선택할 때 호출할 이벤트 핸들러
        session.onshippingmethodselected = (event)=>{
            const update = {
            };
            // 30초 시간 초과 전에 호출하여 응답
            session.completeShippingMethodSelection(update);
        };
        // 사용자가 지불 명세서에서 배송 연락처를 선택할 때 호출할 이벤트
        session.onshippingcontactselected = (event)=>{
            // Define ApplePayShippingContactUpdate based on the selected shipping contact.
            const update = {
            };
            session.completeShippingContactSelection(update);
        };
        // 사용자가 Touch ID, Face ID 또는 암호로 Apple Pay 결제를 승인할 때 시스템이 호출하는 이벤트 
        session.onpaymentauthorized = (event)=>{
            alert(event);

            const result = {
                status: ApplePaySession.STATUS_SUCCESS
            };
            session.completePayment(result);
        };
        // 결제 UI가 닫힐 때 자동으로 호출되는 이벤트 핸들러
        session.oncancel = (event)=>{
        // Payment cancelled by WebKit
            alert("창이 닫힙니다.");
        };
        session.begin();
    }
    document.getElementById('applePay').addEventListener('click', ()=>{
        console.log('clickd');
        buttonClick();
    });

  </script>